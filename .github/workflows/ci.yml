name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Test Plugin Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install fz framework
      run: |
        pip install git+https://github.com/Funz/fz.git
     
    - name: Validate JSON files
      run: |
        echo "Validating model files..."
        for f in .fz/models/*.json; do
          echo "  Checking $f"
          python -m json.tool "$f" > /dev/null
        done
        echo "Validating calculator config files..."
        for f in .fz/calculators/*.json; do
          echo "  Checking $f"
          python -m json.tool "$f" > /dev/null
        done
    
    - name: Check shell script syntax
      run: |
        echo "Checking shell scripts..."
        for f in .fz/calculators/*.sh; do
          echo "  Checking $f"
          bash -n "$f"
        done
    
    - name: Test fzi (parse variables)
      run: |
        python -c "
        import fz
        variables = fz.fzi('examples/CASMO/input.inp', 'CASMO')
        print(f'Variables found: {list(variables.keys())}')
        assert 'enrichment' in variables, 'Variable enrichment not found'
        print('✓ fzi test passed')
        "
    
    - name: Test fzc (compile input)
      run: |
        python -c "
        import fz
        import tempfile
        import os
        with tempfile.TemporaryDirectory() as tmpdir:
            fz.fzc('examples/CASMO/input.inp', {'enrichment': 4.0, 'fuel_temp': 900, 'moderator_temp': 580, 'burnup_steps': 50}, 'CASMO', output_dir=tmpdir)
            # Find the compiled file
            for root, dirs, files in os.walk(tmpdir):
                for f in files:
                    if f == 'input.inp':
                        compiled = os.path.join(root, f)
                        assert os.path.exists(compiled), 'Compiled file not created'
                        with open(compiled) as cf:
                            content = cf.read()
                            assert '4.0' in content or '4' in content, 'Variable not substituted'
                        break
        print('✓ fzc test passed')
        "

    - name: Run plugin tests
      run: |
        python tests/test_plugin.py
    
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check shell scripts are executable
      run: |
        for f in .fz/calculators/*.sh; do
          if [ ! -x "$f" ]; then
            echo "Error: $f is not executable"
            exit 1
          fi
        done

  docs:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check required documentation files
      run: |
        for f in README.md LICENSE; do
          if [ ! -f "$f" ]; then
            echo "Error: Missing $f"
            exit 1
          fi
          echo "✓ $f exists"
        done
    
    - name: Check example files
      run: |
        if [ ! -f "examples/CASMO/input.inp" ]; then
          echo "Error: Missing example input file"
          exit 1
        fi
        echo "✓ Example files present"
